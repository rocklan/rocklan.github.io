---
date: 2006-05-02
category: technical
readtime: true
---
<h3>Updating sequences that might be dodgy</h3>
<br /><p>If you've copied data from another schema into a table of yours, you might have the problem where the sequence that you're using for your Primary Key is now invalid. Here's how to troubleshoot the problem, an example set of data, and some example Java code to fix it.</p><h4>Example</h4>
<p>Let's say we have a table named TBL1:</p><pre><br />  select * from TBL1<br /> <br />      TBL_ID         DESCRIPTION<br />      -----------    ---------------------<br />      1              example item<br />      2              another item<br /><br /><br />  select TBL_ID_SEQ.nextval as val from DUAL<br />  <br />            VAL<br />      ---------<br />              3<br /></pre><p>Everything is currently good. However if we want to copy a few items from another database, we're going to end up with the following:</p><pre><br />    select * from TBL1<br /><br />        TBL_ID         DESCRIPTION<br />        -----------    ---------------------<br />        1              example item<br />        2              another item<br />        100            production item<br />        101            production item2<br /><br /><br />    select TBL_ID_SEQ.nextval as val from DUAL<br /><br />        VAL<br />        -----------    <br />        3<br /></pre><p>Eventually, after we have inserted 97 more ITEMs, we're going to get an error when we try to insert another ITEM with a Primary Key of 100. So what we need to do is update our sequence to 102. First off, to see if the sequences ok, we can do two statements:</p><pre><br />    select TBL_ID_seq.nextval from dual;<br />    select max(TBL_ID) from TBL1;<br /></pre><p>Which gives us the following:</p><pre><br />            NEXTVAL<br />        -----------<br />                  3<br /><br />    MAX(TBL_ID)<br />   -----------------<br />                 101<br /></pre><p>To update the sequence, we need to do the following:</p><pre><br />    select 101 - 3 from dual<br />    <br />                101-3<br />    -----------------<br />                   98<br /><br />    1 row selected.<br /></pre><p>Then use this number to update the increment of the sequence:</p><pre>    alter sequence TBL_ID_seq increment by 98<br /></pre><p>then select from the sequence to increment it:</p><pre>    select TBL_ID_seq.nextval from dual<br /></pre><p>then set the sequence back to increment by 1:</p><pre>    alter sequence TBL_ID_seq increment by 1<br /></pre><p>Now you're done! You'll notice that our sequence number is  now to set to 101. Next time we do a select TBL_ID_SEQ.nextval, it'll be 102, which is exactly what we want.</p><h3>Java code</h3>
<p>Here's some Java code for you to update three separate sequences. To run it you'll have to stick it into your own Java class and setup the database connection. (There's also not a lot of error handling.)</p><pre><br />	/** Function to execute some specified SQL */<br />	private void runSql(String sql) throws SQLException<br />	{<br />		PreparedStatement pstmt = con.prepareStatement(sql);<br />		pstmt.execute();<br />		pstmt.close();<br />	}<br /><br />	/** Function to fetch one int from the DB */<br />	private int runSqlGetNumber(String sql) throws SQLException<br />	{<br />		int i;<br />		PreparedStatement pstmt = con.prepareStatement(sql);<br />		ResultSet rsCount = pstmt.executeQuery();<br />		rsCount.next();<br />		i = rsCount.getInt("c");<br />		rsCount.close();<br />		pstmt.close();<br />		return i;<br />	}<br /><br />	function updateSequences() throws SQLException<br />	{<br />		con = getConnection();<br />		int maxID2, maxID;<br />		int currentID2, currentID;<br />		<br />		maxID2 = runSqlGetNumber("select max(TBL2_ID) as c from TBL2");<br />		maxID = runSqlGetNumber("select max(TBL_ID) as c from TBL1");<br /><br />		currentID2 = runSqlGetNumber("select TBL2_ID_SEQ.nextval as c from dual");<br />		currentID = runSqlGetNumber("select TBL_ID_SEQ.nextval as c from dual");<br /><br />		if (currentID2 <= maxID2)<br />		{<br />			runSql("alter sequence TBL2_ID_SEQ increment by " + (maxID2 - currentID2));<br />			runSql("select TBL2_ID_SEQ.nextval from dual");<br />			runSql("alter sequence TBL2_ID_SEQ increment by 1");<br />		}<br /><br />		if (currentID <= maxID)<br />		{<br />			runSql("alter sequence TBL_ID_SEQ increment by " + (maxID - currentID));<br />			runSql("select TBL_ID_SEQ.nextval from dual");<br />			runSql("alter sequence TBL_ID_SEQ increment by 1");<br />		}<br /><br />		con.close();<br />	}<br /></pre><p>